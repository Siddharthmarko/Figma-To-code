<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Push Notifications Example</title>
</head>
<body>
  <button onclick="initializePushNotifications()">Enable Push Notifications</button>
  <button onclick="sendNotification()">Send Test Notification</button>

  <script>
    // Define the public key for push notifications
    const pushServerPublicKey = "BIN2Jc5Vmkmy-S3AUrcMlpKxJpLeVRAfu9WBqUbJ70SJOCWGCGXKY-Xzyh7HDr6KbRDGYHjqZ06OcS3BjD7uAm8";

    // Check if push notifications and service workers are supported
    function isPushNotificationSupported() {
      return "serviceWorker" in navigator && "PushManager" in window;
    }

    // Request user consent to receive push notifications
    function initializePushNotifications() {
      if (!isPushNotificationSupported()) {
        alert("Push notifications are not supported by your browser.");
        return;
      }

      Notification.requestPermission().then(function(result) {
        if (result === 'granted') {
          registerServiceWorker();
          createNotificationSubscription();
        }
      });
    }

    // Register the service worker
    function registerServiceWorker() {
      navigator.serviceWorker.register("/sw.js").then(function(swRegistration) {
        // Service worker registration successful
        console.log('Service Worker registered');
      }).catch(function(error) {
        console.error('Service Worker registration failed:', error);
      });
    }

    // Send a test notification
    function sendNotification() {
      const img = "/images/jason-leung-HM6TMmevbZQ-unsplash.jpg";
      const text = "Take a look at this brand new t-shirt!";
      const title = "New Product Available";
      const options = {
        body: text,
        icon: "/images/jason-leung-HM6TMmevbZQ-unsplash.jpg",
        vibrate: [200, 100, 200],
        tag: "new-product",
        image: img,
        badge: "https://spyna.it/icons/android-icon-192x192.png",
        actions: [{ action: "Detail", title: "View", icon: "https://via.placeholder.com/128/ff0000" }]
      };
      
      navigator.serviceWorker.ready.then(function(serviceWorker) {
        serviceWorker.showNotification(title, options);
      });
    }

    // Create a push notification subscription
    function createNotificationSubscription() {
      navigator.serviceWorker.ready.then(function(serviceWorker) {
        serviceWorker.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(pushServerPublicKey)
        }).then(function(subscription) {
          console.log("User is subscribed.", subscription);
          // Send subscription to server if needed
        }).catch(function(error) {
          console.error("Failed to subscribe the user: ", error);
        });
      });
    }

    // Helper function to convert base64 string to Uint8Array
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Check if the user is already subscribed
    function getUserSubscription() {
      navigator.serviceWorker.ready.then(function(serviceWorker) {
        serviceWorker.pushManager.getSubscription().then(function(pushSubscription) {
          if (pushSubscription) {
            console.log("User is subscribed.", pushSubscription);
          } else {
            console.log("User is not subscribed.");
          }
        });
      });
    }
  </script>
</body>
</html>
